name: Require Gemini AI Review (Improved)

     # Purpose:
     # - Enforce that PRs have the `ai-review` label before proceeding.
     # - Provide multiple bypass mechanisms for experimental/urgent workflows
     # Complements:
     # - `ai-review-labels.yml` which manages applying `ai-review`/`ai-review-requested` labels.
     # - `auto-merge-coordinator.yml` which also checks labels during coordination.
     # Note: This job is a focused, fast-fail check. Keep it, but avoid duplicating the same blocking
     # message elsewhere to reduce noise.

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-ai-review:
    name: Check for 'ai-review' label or bypass
    runs-on: ubuntu-latest
    steps:
      - name: Ensure Gemini review label present or bypass active
        id: ensure-label
        run: |
          NUMBER='${{ github.event.pull_request.number }}'
          LABELS=$(gh --repo "${{ github.repository }}" pr view "$NUMBER" --json labels --jq '[.labels[].name] | join(",")')
          echo "PR Labels: $LABELS"
          
          # Convert to CSV format for easier matching
          CSV=",$LABELS,"
          
          # Check for AI review completion
          if echo "$CSV" | grep -q ',ai-review,'; then
            echo "✅ Gemini AI review label present - proceeding"
          else
            echo "ℹ️ Advisory: Missing 'ai-review' label (no longer required)."
            {
              echo "## Gemini AI Review (Advisory)"
              echo "- PR: #$NUMBER"
              echo "- Status: Missing 'ai-review' label"
              echo "- Action: Optional — comment '/gemini review' to request a review"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
          # Always succeed — AI review is advisory, not required
          exit 0
        env:
          GH_TOKEN: ${{ github.token }}